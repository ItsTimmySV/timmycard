<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finanzas Simple • Ingresos y Gastos</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#1f2937;       /* gray-800 */
      --card:#0b1222;        /* deep panel */
      --text:#e5e7eb;        /* gray-200 */
      --text-dim:#9ca3af;    /* gray-400 */
      --accent:#22c55e;      /* green-500 */
      --danger:#ef4444;      /* red-500 */
      --warning:#f59e0b;     /* amber-500 */
      --info:#3b82f6;        /* blue-500 */
      --radius:16px;
      --shadow:0 10px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #172554 0%, transparent 50%),
                  radial-gradient(1000px 1000px at 110% 10%, #083344 0%, transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--info); text-decoration:none}

    .container{max-width:1100px; margin:0 auto; padding:24px}

    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:18px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg, var(--info), var(--accent));
      box-shadow:var(--shadow);
    }
    h1{font-size:clamp(18px, 2vw, 22px); margin:0; font-weight:700}
    .sub{color:var(--text-dim); font-size:14px}

    .grid{
      display:grid; gap:14px; grid-template-columns: repeat(12, 1fr);
    }
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.25));
      border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}

    /* Summary cards */
    .summary{grid-column: span 12; display:grid; gap:14px; grid-template-columns: repeat(12, 1fr)}
    .kpi{grid-column: span 12; padding:18px; display:flex; align-items:center; justify-content:space-between; gap:10px}
    .kpi h3{margin:0; font-size:14px; color:var(--text-dim); font-weight:600}
    .kpi .val{font-size:clamp(18px, 3vw, 28px); font-weight:800}
    .kpi.income{background:linear-gradient(180deg, rgba(34,197,94,.12), rgba(0,0,0,.15)); border-color:rgba(34,197,94,.35)}
    .kpi.expense{background:linear-gradient(180deg, rgba(239,68,68,.12), rgba(0,0,0,.15)); border-color:rgba(239,68,68,.35)}
    .kpi.balance{background:linear-gradient(180deg, rgba(59,130,246,.12), rgba(0,0,0,.15)); border-color:rgba(59,130,246,.35)}

    @media(min-width:700px){
      .kpi{grid-column: span 4}
    }

    /* Left column: form & filters; Right: table */
    .left{grid-column: span 12}
    .right{grid-column: span 12}
    @media(min-width:900px){
      .left{grid-column: span 4}
      .right{grid-column: span 8}
    }

    .section-title{margin:0 0 8px; font-size:14px; color:var(--text-dim); font-weight:700; letter-spacing:.4px}

    .form-grid{display:grid; gap:10px; grid-template-columns: repeat(12, 1fr)}
    label{font-size:12px; color:var(--text-dim)}
    input, select, textarea{
      width:100%; padding:10px 12px; background:#0b1020; color:var(--text);
      border:1px solid rgba(255,255,255,.08); border-radius:12px; outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--info); box-shadow:0 0 0 3px rgba(59,130,246,.25)}

    .row-6{grid-column: span 12}
    .row-4{grid-column: span 12}
    .row-3{grid-column: span 12}
    .row-2{grid-column: span 12}
    @media(min-width:700px){
      .row-6{grid-column: span 6}
      .row-4{grid-column: span 4}
      .row-3{grid-column: span 3}
      .row-2{grid-column: span 2}
    }

    .actions{display:flex; flex-wrap:wrap; gap:8px}
    .btn{border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700; color:#0b0f1a}
    .btn.primary{background:linear-gradient(135deg, var(--info), #60a5fa); color:white}
    .btn.ghost{background:#0b1020; color:var(--text); border:1px solid rgba(255,255,255,.12)}
    .btn.danger{background:linear-gradient(135deg, var(--danger), #f87171); color:white}
    .btn.warning{background:linear-gradient(135deg, var(--warning), #fbbf24); color:#0b0f1a}

    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center}

    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    thead th{font-size:12px; color:var(--text-dim); text-align:left; padding:0 10px}
    tbody tr{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.25));}
    tbody td{padding:12px 10px; border-top:1px solid rgba(255,255,255,.08); border-bottom:1px solid rgba(255,255,255,.08)}
    tbody tr:first-child td{border-top-left-radius:12px; border-top-right-radius:12px}
    tbody tr:last-child td{border-bottom-left-radius:12px; border-bottom-right-radius:12px}
    .chip{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px}
    .chip.income{background:rgba(34,197,94,.15); color:#86efac; border:1px solid rgba(34,197,94,.35)}
    .chip.expense{background:rgba(239,68,68,.15); color:#fca5a5; border:1px solid rgba(239,68,68,.35)}

    .muted{color:var(--text-dim)}

    .footer{margin-top:16px; color:var(--text-dim); font-size:12px; text-align:center}
    .hide{display:none !important}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:8px 0 14px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Finanzas Simple</h1>
          <div class="sub">Controla ingresos y gastos • Guarda en tu navegador</div>
        </div>
      </div>
      <div class="toolbar card" style="padding:8px 10px">
        <button class="btn ghost" id="btnExportar" title="Exportar JSON">Exportar</button>
        <input type="file" id="fileImport" accept="application/json" class="hide" />
        <button class="btn ghost" id="btnImportar" title="Importar JSON">Importar</button>
        <button class="btn danger" id="btnVaciar" title="Borrar todo">Vaciar</button>
      </div>
    </header>

    <section class="summary">
      <div class="kpi card income">
        <div>
          <h3>Ingresos</h3>
          <div class="val" id="kpiIngresos">$0.00</div>
        </div>
        <div class="muted" id="kpiIngresosCount">0 movs</div>
      </div>
      <div class="kpi card expense">
        <div>
          <h3>Gastos</h3>
          <div class="val" id="kpiGastos">$0.00</div>
        </div>
        <div class="muted" id="kpiGastosCount">0 movs</div>
      </div>
      <div class="kpi card balance">
        <div>
          <h3>Balance</h3>
          <div class="val" id="kpiBalance">$0.00</div>
        </div>
        <div class="muted" id="kpiPeriodo">—</div>
      </div>
    </section>

    <section class="grid" style="margin-top:14px">
      <!-- Left column -->
      <div class="left">
        <div class="card">
          <div class="section-title">Agregar movimiento</div>
          <div class="hr"></div>
          <form id="formMov" class="form-grid" autocomplete="off">
            <input type="hidden" id="movId" />
            <div class="row-6">
              <label for="fecha">Fecha</label>
              <input type="date" id="fecha" required />
            </div>
            <div class="row-6">
              <label for="tipo">Tipo</label>
              <select id="tipo" required>
                <option value="ingreso">Ingreso</option>
                <option value="gasto">Gasto</option>
              </select>
            </div>
            <div class="row-6">
              <label for="categoria">Categoría</label>
              <input list="catlist" id="categoria" placeholder="Ej. Comida, Renta..." required />
              <datalist id="catlist">
                <option>Renta</option>
                <option>Servicios</option>
                <option>Comida</option>
                <option>Transporte</option>
                <option>Salud</option>
                <option>Educación</option>
                <option>Entretenimiento</option>
                <option>Salario</option>
                <option>Ventas</option>
                <option>Otros</option>
              </datalist>
            </div>
            <div class="row-6">
              <label for="monto">Monto</label>
              <input type="number" id="monto" step="0.01" inputmode="decimal" placeholder="0.00" required />
            </div>
            <div class="row-12">
              <label for="desc">Descripción (opcional)</label>
              <input type="text" id="desc" placeholder="Nota, referencia..." />
            </div>
            <div class="row-12 actions">
              <button class="btn primary" type="submit" id="btnGuardar">Guardar</button>
              <button class="btn ghost" type="button" id="btnReset">Limpiar</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="section-title">Filtros</div>
          <div class="hr"></div>
          <div class="form-grid">
            <div class="row-6">
              <label for="desde">Desde</label>
              <input type="date" id="desde" />
            </div>
            <div class="row-6">
              <label for="hasta">Hasta</label>
              <input type="date" id="hasta" />
            </div>
            <div class="row-6">
              <label for="filtroTipo">Tipo</label>
              <select id="filtroTipo">
                <option value="todos">Todos</option>
                <option value="ingreso">Ingresos</option>
                <option value="gasto">Gastos</option>
              </select>
            </div>
            <div class="row-6">
              <label for="filtroCat">Categoría</label>
              <input list="catlist" id="filtroCat" placeholder="Todas" />
            </div>
            <div class="row-12">
              <label for="buscar">Buscar</label>
              <input id="buscar" placeholder="Descripción o categoría" />
            </div>
            <div class="row-12 actions">
              <button class="btn ghost" id="btnAplicarFiltros">Aplicar</button>
              <button class="btn ghost" id="btnQuitarFiltros">Quitar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="right card">
        <div class="section-title">Movimientos</div>
        <div class="hr"></div>
        <div class="toolbar" style="margin-bottom:8px">
          <span class="muted" id="contador">0 resultados</span>
          <span class="muted" style="margin-left:auto">Orden: 
            <select id="orden">
              <option value="fecha-desc">Fecha ↓</option>
              <option value="fecha-asc">Fecha ↑</option>
              <option value="monto-desc">Monto ↓</option>
              <option value="monto-asc">Monto ↑</option>
            </select>
          </span>
        </div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Categoría</th>
                <th>Descripción</th>
                <th style="text-align:right">Monto</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <div class="footer">Tus datos se guardan en este navegador (localStorage). Importa/Exporta para respaldos.</div>
  </div>

  <script>
    // === Configuración básica ===
    const LS_KEY = 'finapp.transactions.v1';

    /** @type {Array<{id:string,date:string,type:'ingreso'|'gasto',category:string,description?:string,amount:number}>} */
    let data = load();

    // Estado de filtros
    const state = {
      from: '',
      to: '',
      type: 'todos',
      category: '',
      q: '',
      order: 'fecha-desc'
    };

    // Elementos UI
    const el = id => document.getElementById(id);
    const tbody = el('tbody');

    // Inicializar
    init();

    function init(){
      // Defaults
      const today = new Date().toISOString().slice(0,10);
      el('fecha').value = today;

      // Eventos form
      el('formMov').addEventListener('submit', onSave);
      el('btnReset').addEventListener('click', resetForm);

      // Filtros
      el('btnAplicarFiltros').addEventListener('click', e=>{e.preventDefault(); applyFiltersFromUI(); render();});
      el('btnQuitarFiltros').addEventListener('click', e=>{e.preventDefault(); resetFilters(); render();});
      el('orden').addEventListener('change', ()=>{state.order = el('orden').value; render();});

      // Import/Export
      el('btnExportar').addEventListener('click', exportJSON);
      el('btnImportar').addEventListener('click', ()=> el('fileImport').click());
      el('fileImport').addEventListener('change', importJSON);
      el('btnVaciar').addEventListener('click', clearAll);

      render();
    }

    // === Persistencia ===
    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)) return arr;
        return [];
      }catch{ return [] }
    }
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    // === CRUD ===
    function onSave(e){
      e.preventDefault();
      const id = el('movId').value || crypto.randomUUID();
      const date = el('fecha').value;
      const type = el('tipo').value;
      const category = (el('categoria').value || '').trim();
      const description = (el('desc').value || '').trim();
      const amount = parseFloat(el('monto').value);

      if(!date || !category || !type || isNaN(amount)){
        alert('Completa fecha, tipo, categoría y monto.');
        return;
      }

      // Monto siempre positivo internamente; signo se maneja por type
      const record = { id, date, type, category, description, amount: Math.abs(amount) };

      const idx = data.findIndex(x=>x.id===id);
      if(idx>=0){ data[idx] = record; }
      else { data.push(record); }
      save();
      resetForm();
      render();
    }

    function editRow(id){
      const r = data.find(x=>x.id===id); if(!r) return;
      el('movId').value = r.id;
      el('fecha').value = r.date;
      el('tipo').value = r.type;
      el('categoria').value = r.category;
      el('monto').value = r.amount.toFixed(2);
      el('desc').value = r.description || '';
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function deleteRow(id){
      if(!confirm('¿Eliminar este movimiento?')) return;
      data = data.filter(x=>x.id!==id);
      save();
      render();
    }

    function resetForm(){
      el('movId').value = '';
      el('tipo').value = 'ingreso';
      el('categoria').value = '';
      el('monto').value = '';
      el('desc').value = '';
      el('fecha').value = new Date().toISOString().slice(0,10);
    }

    // === Filtrado + Orden ===
    function applyFiltersFromUI(){
      state.from = el('desde').value || '';
      state.to = el('hasta').value || '';
      state.type = el('filtroTipo').value;
      state.category = (el('filtroCat').value || '').trim();
      state.q = (el('buscar').value || '').trim().toLowerCase();
    }

    function resetFilters(){
      state.from = ''; state.to = ''; state.type = 'todos'; state.category = ''; state.q='';
      el('desde').value=''; el('hasta').value=''; el('filtroTipo').value='todos'; el('filtroCat').value=''; el('buscar').value='';
    }

    function getFilteredSorted(){
      let arr = [...data];
      // Filtros
      if(state.from) arr = arr.filter(r=> r.date >= state.from);
      if(state.to) arr = arr.filter(r=> r.date <= state.to);
      if(state.type!=='todos') arr = arr.filter(r=> r.type===state.type);
      if(state.category) arr = arr.filter(r=> r.category.toLowerCase() === state.category.toLowerCase());
      if(state.q) arr = arr.filter(r=> (r.description||'').toLowerCase().includes(state.q) || r.category.toLowerCase().includes(state.q));

      // Orden
      const [key,dir] = state.order.split('-');
      arr.sort((a,b)=>{
        let res = 0;
        if(key==='fecha'){ res = a.date.localeCompare(b.date); }
        if(key==='monto'){ res = a.amount - b.amount; }
        return dir==='asc' ? res : -res;
      });

      return arr;
    }

    // === Render ===
    function render(){
      const rows = getFilteredSorted();
      el('contador').textContent = `${rows.length} resultado${rows.length!==1?'s':''}`;

      // KPIs
      const ingresos = rows.filter(r=>r.type==='ingreso').reduce((s,r)=>s+r.amount,0);
      const gastos = rows.filter(r=>r.type==='gasto').reduce((s,r)=>s+r.amount,0);
      const balance = ingresos - gastos;
      el('kpiIngresos').textContent = formatMoney(ingresos);
      el('kpiGastos').textContent = formatMoney(gastos);
      el('kpiBalance').textContent = formatMoney(balance);
      el('kpiIngresosCount').textContent = `${rows.filter(r=>r.type==='ingreso').length} movs`;
      el('kpiGastosCount').textContent = `${rows.filter(r=>r.type==='gasto').length} movs`;
      el('kpiPeriodo').textContent = periodLabel();

      // Tabla
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td class="muted">${r.date}</td>
          <td><span class="chip ${r.type}">${r.type==='ingreso'?'Ingreso':'Gasto'}</span></td>
          <td>${escapeHtml(r.category)}</td>
          <td class="muted">${escapeHtml(r.description||'—')}</td>
          <td style="text-align:right; font-weight:700">${formatMoney(r.amount)}</td>
          <td style="text-align:right">
            <button class="btn ghost" onclick="editRow('${r.id}')">Editar</button>
            <button class="btn danger" onclick="deleteRow('${r.id}')">Eliminar</button>
          </td>
        </tr>
      `).join('');
    }

    function periodLabel(){
      const a = state.from ? state.from : 'inicio';
      const b = state.to ? state.to : 'hoy';
      if(a==='inicio' && b==='hoy') return 'Todo el periodo';
      return `${a} → ${b}`;
    }

    // === Utilidades ===
    function formatMoney(n){
      return new Intl.NumberFormat('es-SV',{style:'currency', currency:'USD'}).format(Number(n||0));
    }
    function escapeHtml(s){return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

    // === Import / Export ===
    function exportJSON(){
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href = URL.createObjectURL(blob);
      a.download = `finanzas-backup-${ts}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function importJSON(ev){
      const file = ev.target.files[0]; if(!file) return;
      try{
        const text = await file.text();
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error('Formato inválido');
        // Opciones: fusionar o reemplazar
        const mode = confirm('OK = Reemplazar todo. Cancel = Fusionar.');
        if(mode){ // Reemplazar
          data = sanitize(arr);
        }else{ // Fusionar por id
          const map = new Map(data.map(x=>[x.id,x]));
          for(const r of sanitize(arr)) map.set(r.id, r);
          data = Array.from(map.values());
        }
        save();
        render();
        alert('Importación completada.');
      }catch(err){
        alert('No se pudo importar: '+ err.message);
      }finally{
        ev.target.value = '';
      }
    }

    function sanitize(arr){
      return arr.map(r=>({
        id: String(r.id||crypto.randomUUID()),
        date: String(r.date||'').slice(0,10),
        type: r.type==='ingreso'?'ingreso':'gasto',
        category: String(r.category||'Otros'),
        description: r.description? String(r.description):'',
        amount: Math.abs(Number(r.amount||0))
      })).filter(r=> r.date && r.category && !isNaN(r.amount));
    }

    function clearAll(){
      if(!confirm('¿Borrar TODOS los movimientos? Esta acción no se puede deshacer.')) return;
      data = [];
      save();
      render();
    }

    // Exponer funciones para botones en la tabla
    window.editRow = editRow;
    window.deleteRow = deleteRow;
  </script>
</body>
</html>
