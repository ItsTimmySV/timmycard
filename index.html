<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Finanzas Personales</title>
    <meta name="description" content="App web para gestionar ingresos, gastos, presupuestos, deudas y reportes. 100% local, funciona en cualquier navegador." />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%24%3C/text%3E%3C/svg%3E" />
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Recharts (UMD) -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <!-- Babel para transpilar JSX en el navegador (solo para GitHub Pages / hosting est√°tico) -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <div id="root" class="min-h-screen"></div>

    <!-- App en JSX; Babel lo transpila on-the-fly en cualquier navegador moderno -->
    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;
      const {
        LineChart,
        Line,
        PieChart,
        Pie,
        BarChart,
        Bar,
        XAxis,
        YAxis,
        Tooltip,
        Legend,
        ResponsiveContainer,
        Cell,
        CartesianGrid,
      } = Recharts;

      // ------------------------- Utilidades ---------------------------------
      const todayISO = () => new Date().toISOString().slice(0, 10);
      const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4);
      const fmtMoney = (n, currency) => new Intl.NumberFormat("es-SV", { style: "currency", currency }).format(Number(n || 0));
      const monthKey = (d) => { const dt = new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, "0")}`; };
      const startOfMonth = (date) => new Date(new Date(date).getFullYear(), new Date(date).getMonth(), 1);
      const endOfMonth   = (date) => new Date(new Date(date).getFullYear(), new Date(date).getMonth() + 1, 0);

      // Categor√≠as base (puedes editar en Configuraci√≥n)
      const DEFAULT_CATEGORIES = {
        ingreso: ["Salario", "Ventas", "Intereses", "Devoluciones", "Otros"],
        gasto: [
          "Alimentaci√≥n",
          "Transporte",
          "Vivienda",
          "Servicios (agua/luz/internet)",
          "Educaci√≥n",
          "Salud",
          "Entretenimiento",
          "Suscripciones",
          "Ropa",
          "Impuestos",
          "Deudas (pagos)",
          "Ahorro/Inversi√≥n",
          "Otros",
        ],
      };

      // Paleta para gr√°ficos
      const CHART_COLORS = [
        "#2563eb","#16a34a","#f59e0b","#ef4444","#10b981","#8b5cf6","#f43f5e","#22c55e","#3b82f6","#eab308","#06b6d4","#a855f7","#84cc16",
      ];

      // ------------------------- Storage Layer -------------------------------
      const STORAGE_KEY = "finance_app_v1";
      const loadState = () => { try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; } };
      const saveState = (state) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch { /* no-op */ } };

      // --------------------------- App --------------------------------------
      function FinanceApp() {
        // Estado ra√≠z
        const [transactions, setTransactions] = useState(() => loadState()?.transactions || []);
        const [budgets, setBudgets]         = useState(() => loadState()?.budgets || {}); // {"YYYY-MM": { categoria: monto }}
        const [debts, setDebts]             = useState(() => loadState()?.debts || []);
        const [settings, setSettings]       = useState(() => loadState()?.settings || { currency: "USD", categories: DEFAULT_CATEGORIES, theme: "light", startBalance: 0 });
        const [activeTab, setActiveTab]     = useState("dashboard");

        // Persistencia
        useEffect(() => { saveState({ transactions, budgets, debts, settings }); }, [transactions, budgets, debts, settings]);

        // Tema
        useEffect(() => {
          const root = document.documentElement;
          if (settings.theme === "dark") root.classList.add("dark"); else root.classList.remove("dark");
        }, [settings.theme]);

        // Derivados
        const currentMonth = monthKey(new Date());
        const txCurrentMonth = useMemo(() => transactions.filter((t) => monthKey(t.date) === currentMonth), [transactions, currentMonth]);
        const totals = useMemo(() => {
          const inc = txCurrentMonth.filter((t) => t.type === "ingreso").reduce((a, b) => a + Number(b.amount), 0);
          const exp = txCurrentMonth.filter((t) => t.type === "gasto").reduce((a, b) => a + Number(b.amount), 0);
          return { income: inc, expense: exp, net: inc - exp };
        }, [txCurrentMonth]);
        const categoriesSpent = useMemo(() => {
          const acc = {};
          txCurrentMonth.filter((t) => t.type === "gasto").forEach((t) => acc[t.category] = (acc[t.category] || 0) + Number(t.amount));
          return Object.entries(acc).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
        }, [txCurrentMonth]);
        const monthsSeries = useMemo(() => {
          const now = new Date(); const points = [];
          for (let i = 11; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const key = monthKey(d);
            const tx = transactions.filter((t) => monthKey(t.date) === key);
            const inc = tx.filter((t) => t.type === "ingreso").reduce((a, b) => a + Number(b.amount), 0);
            const exp = tx.filter((t) => t.type === "gasto").reduce((a, b) => a + Number(b.amount), 0);
            points.push({ month: key, Ingresos: inc, Gastos: exp, Neto: inc - exp });
          }
          return points;
        }, [transactions]);
        const categoryBudgetThisMonth = budgets[currentMonth] || {};

        // Acciones
        const addTransaction    = (t) => setTransactions((s) => [{ ...t, id: uid() }, ...s]);
        const updateTransaction = (id, patch) => setTransactions((s) => s.map((t) => (t.id === id ? { ...t, ...patch } : t)));
        const deleteTransaction = (id) => setTransactions((s) => s.filter((t) => t.id !== id));

        const upsertBudget = (month, category, amount) => setBudgets((s) => ({ ...s, [month]: { ...(s[month] || {}), [category]: Number(amount) } }));
        const deleteBudget = (month, category) => setBudgets((s) => { const next = { ...s }; const m = { ...(next[month] || {}) }; delete m[category]; next[month] = m; return next; });

        const addDebt    = (d) => setDebts((s) => [{ ...d, id: uid() }, ...s]);
        const updateDebt = (id, patch) => setDebts((s) => s.map((d) => (d.id === id ? { ...d, ...patch } : d)));
        const deleteDebt = (id) => setDebts((s) => s.filter((d) => d.id !== id));

        const exportJSON = () => {
          const data = JSON.stringify({ transactions, budgets, debts, settings }, null, 2);
          const blob = new Blob([data], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a"); a.href = url; a.download = `finanzas_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url);
        };
        const importJSON = (file) => {
          const reader = new FileReader();
          reader.onload = (e) => { try { const obj = JSON.parse(e.target.result); setTransactions(obj.transactions || []); setBudgets(obj.budgets || {}); setDebts(obj.debts || []); setSettings((s) => ({ ...s, ...(obj.settings || {}) })); } catch { alert("Archivo inv√°lido"); } };
          reader.readAsText(file);
        };

        return (
          <div className="min-h-screen">
            <Header settings={settings} setSettings={setSettings} onExport={exportJSON} onImport={importJSON} />
            <main className="mx-auto max-w-7xl px-3 sm:px-6 pb-24">
              <TopSummary totals={totals} currency={settings.currency} />
              <Tabs activeTab={activeTab} setActiveTab={setActiveTab} />

              {activeTab === "dashboard" && (
                <Dashboard
                  transactions={transactions}
                  settings={settings}
                  categoriesSpent={categoriesSpent}
                  monthsSeries={monthsSeries}
                  budgets={budgets}
                  currentMonth={currentMonth}
                />
              )}

              {activeTab === "transacciones" && (
                <TransactionsTab
                  transactions={transactions}
                  addTransaction={addTransaction}
                  updateTransaction={updateTransaction}
                  deleteTransaction={deleteTransaction}
                  categories={settings.categories}
                  currency={settings.currency}
                />
              )}

              {activeTab === "presupuestos" && (
                <BudgetsTab
                  budgets={budgets}
                  upsertBudget={upsertBudget}
                  deleteBudget={deleteBudget}
                  categories={settings.categories}
                  currency={settings.currency}
                  month={currentMonth}
                  expensesThisMonth={categoriesSpent}
                />
              )}

              {activeTab === "deudas" && (
                <DebtsTab
                  debts={debts}
                  addDebt={addDebt}
                  updateDebt={updateDebt}
                  deleteDebt={deleteDebt}
                  currency={settings.currency}
                />
              )}

              {activeTab === "reportes" && (
                <ReportsTab transactions={transactions} currency={settings.currency} categories={settings.categories} />
              )}

              {activeTab === "config" && <SettingsTab settings={settings} setSettings={setSettings} />}
            </main>
            <Footer />
          </div>
        );
      }

      // ---------------------- Componentes UI -------------------------------
      function Header({ settings, setSettings, onExport, onImport }) {
        const fileRef = useRef(null);
        return (
          <header className="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:supports-[backdrop-filter]:bg-slate-900/70 bg-white/90 dark:bg-slate-900/90 border-b border-slate-200 dark:border-slate-800">
            <div className="mx-auto max-w-7xl px-3 sm:px-6 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <span className="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-indigo-600 text-white font-semibold">$</span>
                <div>
                  <h1 className="text-lg sm:text-xl font-bold leading-tight">Finanzas Personales</h1>
                  <p className="text-xs text-slate-500 dark:text-slate-400 hidden sm:block">Control total: ingresos, gastos, presupuestos, deudas y reportes</p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setSettings((s) => ({ ...s, theme: s.theme === "light" ? "dark" : "light" }))}
                  className="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-slate-700 text-sm hover:bg-slate-100 dark:hover:bg-slate-800"
                  title="Tema claro/oscuro"
                >
                  {settings.theme === "light" ? "üåô" : "‚òÄÔ∏è"}
                </button>
                <button onClick={onExport} className="px-3 py-1.5 rounded-xl bg-slate-900 dark:bg-slate-100 dark:text-slate-900 text-white text-sm hover:opacity-90">Exportar JSON</button>
                <input ref={fileRef} type="file" accept="application/json" className="hidden" onChange={(e) => e.target.files?.[0] && onImport(e.target.files[0])} />
                <button onClick={() => fileRef.current?.click()} className="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-slate-700 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">Importar</button>
              </div>
            </div>
          </header>
        );
      }

      function Footer() {
        return (
          <footer className="border-t border-slate-200 dark:border-slate-800 py-6 text-center text-xs text-slate-500 dark:text-slate-400">
            <div className="mx-auto max-w-7xl px-3 sm:px-6">
              Hecho con ‚ù§Ô∏è ¬∑ Datos guardados localmente en tu navegador.
            </div>
          </footer>
        );
      }

      function Tabs({ activeTab, setActiveTab }) {
        const tabs = [
          { id: "dashboard", label: "Dashboard" },
          { id: "transacciones", label: "Transacciones" },
          { id: "presupuestos", label: "Presupuestos" },
          { id: "deudas", label: "Deudas" },
          { id: "reportes", label: "Reportes" },
          { id: "config", label: "Configuraci√≥n" },
        ];
        return (
          <div className="mt-4 mb-6 overflow-auto">
            <div className="inline-flex gap-1 rounded-2xl border border-slate-200 dark:border-slate-800 p-1">
              {tabs.map((t) => (
                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`px-3 py-1.5 rounded-xl text-sm whitespace-nowrap ${activeTab === t.id ? "bg-slate-900 text-white dark:bg-white dark:text-slate-900" : "hover:bg-slate-100 dark:hover:bg-slate-800"}`}>{t.label}</button>
              ))}
            </div>
          </div>
        );
      }

      function TopSummary({ totals, currency }) {
        const items = [
          { label: "Ingresos del mes", value: fmtMoney(totals.income, currency) },
          { label: "Gastos del mes", value: fmtMoney(totals.expense, currency) },
          { label: "Neto del mes", value: fmtMoney(totals.net, currency) },
        ];
        return (
          <section className="grid grid-cols-1 sm:grid-cols-3 gap-3">
            {items.map((it) => (
              <div key={it.label} className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
                <p className="text-sm text-slate-500 dark:text-slate-400">{it.label}</p>
                <p className="text-2xl font-bold mt-1">{it.value}</p>
              </div>
            ))}
          </section>
        );
      }

      function Dashboard({ transactions, settings, categoriesSpent, monthsSeries, budgets, currentMonth }) {
        const currency = settings.currency;
        const budgetThisMonth = budgets[currentMonth] || {};
        return (
          <section className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div className="lg:col-span-2 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
              <h2 className="font-semibold mb-2">Flujo de caja ‚Äì √∫ltimos 12 meses</h2>
              <div className="h-64">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={monthsSeries}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="month" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Bar dataKey="Ingresos" />
                    <Bar dataKey="Gastos" />
                    <Bar dataKey="Neto" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
              <h2 className="font-semibold mb-2">Gasto por categor√≠a (mes)</h2>
              <div className="h-64">
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie data={categoriesSpent} dataKey="value" nameKey="name" outerRadius={90}>
                      {categoriesSpent.map((_, i) => (
                        <Cell key={i} fill={CHART_COLORS[i % CHART_COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-3">
              <h2 className="font-semibold mb-2">Presupuesto vs gasto (mes)</h2>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left text-slate-500 dark:text-slate-400">
                      <th className="py-2">Categor√≠a</th>
                      <th className="py-2">Presupuesto</th>
                      <th className="py-2">Gastado</th>
                      <th className="py-2">Disponible</th>
                      <th className="py-2">% usado</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.keys(budgetThisMonth).length === 0 && (
                      <tr><td colSpan={5} className="py-3 text-slate-500">Define tus presupuestos en la pesta√±a "Presupuestos"</td></tr>
                    )}
                    {Object.entries(budgetThisMonth).map(([cat, limit]) => {
                      const spent = categoriesSpent.find((c) => c.name === cat)?.value || 0;
                      const available = limit - spent;
                      const pct = limit > 0 ? Math.min(100, Math.round((spent / limit) * 100)) : 0;
                      return (
                        <tr key={cat} className="border-t border-slate-100 dark:border-slate-800">
                          <td className="py-2 font-medium">{cat}</td>
                          <td className="py-2">{fmtMoney(limit, currency)}</td>
                          <td className="py-2">{fmtMoney(spent, currency)}</td>
                          <td className={`py-2 ${available < 0 ? "text-red-600" : ""}`}>{fmtMoney(available, currency)}</td>
                          <td className="py-2">
                            <div className="w-full bg-slate-200 dark:bg-slate-800 rounded-full h-2">
                              <div className={`h-2 rounded-full ${pct < 80 ? "bg-green-500" : pct < 100 ? "bg-amber-500" : "bg-red-500"}`} style={{ width: pct + "%" }} />
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-3">
              <h2 className="font-semibold mb-2">√öltimas transacciones</h2>
              <TransactionList transactions={transactions.slice(0, 8)} currency={currency} compact />
            </div>
          </section>
        );
      }

      function TransactionsTab({ transactions, addTransaction, updateTransaction, deleteTransaction, categories, currency }) {
        return (
          <section className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-1">
              <h2 className="font-semibold mb-2">Agregar transacci√≥n</h2>
              <TransactionForm onSubmit={addTransaction} categories={categories} />
            </div>
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-2">
              <h2 className="font-semibold mb-2">Historial</h2>
              <TransactionList transactions={transactions} currency={currency} onEdit={updateTransaction} onDelete={deleteTransaction} />
            </div>
          </section>
        );
      }

      function TransactionForm({ onSubmit, categories }) {
        const [form, setForm] = useState({ date: todayISO(), type: "gasto", amount: "", category: "Alimentaci√≥n", fixed: false, account: "Billetera", note: "" });
        // Mantener la categor√≠a coherente con el tipo seleccionado
        useEffect(() => {
          const list = form.type === "ingreso" ? categories.ingreso : categories.gasto;
          if (!list.includes(form.category)) setForm((f) => ({ ...f, category: list[0] || "" }));
        }, [form.type, categories]);
        const handleSubmit = (e) => { e.preventDefault(); const amount = Number(form.amount); if (!amount || amount <= 0) return alert("Monto inv√°lido"); onSubmit({ ...form, amount }); setForm((f) => ({ ...f, amount: "", note: "" })); };
        const availableCats = form.type === "ingreso" ? categories.ingreso : categories.gasto;
        return (
          <form onSubmit={handleSubmit} className="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label className="text-xs text-slate-500">Fecha</label>
              <input type="date" value={form.date} onChange={(e) => setForm({ ...form, date: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" />
            </div>
            <div>
              <label className="text-xs text-slate-500">Tipo</label>
              <select value={form.type} onChange={(e) => { const nextType = e.target.value; const nextList = nextType === "ingreso" ? categories.ingreso : categories.gasto; setForm((f) => ({ ...f, type: nextType, category: nextList[0] || "" })); }} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2">
                <option value="ingreso">Ingreso</option>
                <option value="gasto">Gasto</option>
              </select>
            </div>
            <div>
              <label className="text-xs text-slate-500">Monto</label>
              <input type="number" step="0.01" value={form.amount} onChange={(e) => setForm({ ...form, amount: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" placeholder="0.00" />
            </div>
            <div>
              <label className="text-xs text-slate-500">Categor√≠a</label>
              <select value={form.category} onChange={(e) => setForm({ ...form, category: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2">
                {availableCats.map((c) => (<option key={c} value={c}>{c}</option>))}
              </select>
            </div>
            <div>
              <label className="text-xs text-slate-500">Cuenta</label>
              <input value={form.account} onChange={(e) => setForm({ ...form, account: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" placeholder="Banco, Efectivo, Tarjeta" />
            </div>
            <div className="flex items-end justify-between gap-2">
              <div className="flex items-center gap-2">
                <input id="fixed" type="checkbox" checked={form.fixed} onChange={(e) => setForm({ ...form, fixed: e.target.checked })} />
                <label htmlFor="fixed" className="text-sm">Fijo</label>
              </div>
              <button className="ml-auto px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:opacity-90">Agregar</button>
            </div>
            <div className="sm:col-span-2">
              <label className="text-xs text-slate-500">Nota</label>
              <input value={form.note} onChange={(e) => setForm({ ...form, note: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" placeholder="Detalle (opcional)" />
            </div>
          </form>
        );
      }

      function TransactionList({ transactions, currency, onEdit, onDelete, compact }) {
        if (!transactions.length) return <p className="text-sm text-slate-500">Sin transacciones a√∫n. Agrega la primera ‚ûï</p>;
        return (
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-slate-500 dark:text-slate-400">
                  <th className="py-2">Fecha</th>
                  <th className="py-2">Tipo</th>
                  <th className="py-2">Categor√≠a</th>
                  <th className="py-2">Cuenta</th>
                  <th className="py-2">Monto</th>
                  {!compact && <th className="py-2">Fijo</th>}
                  {!compact && <th className="py-2">Nota</th>}
                  {onEdit && <th className="py-2">Acciones</th>}
                </tr>
              </thead>
              <tbody>
                {transactions.map((t) => (
                  <tr key={t.id || `${t.date}-${t.amount}-${t.category}`} className="border-t border-slate-100 dark:border-slate-800">
                    <td className="py-2">{t.date}</td>
                    <td className={`py-2 font-medium ${t.type === "ingreso" ? "text-green-600" : "text-red-600"}`}>{t.type}</td>
                    <td className="py-2">{t.category}</td>
                    <td className="py-2">{t.account || "‚Äî"}</td>
                    <td className="py-2">{fmtMoney(t.amount, currency)}</td>
                    {!compact && <td className="py-2">{t.fixed ? "S√≠" : "No"}</td>}
                    {!compact && <td className="py-2">{t.note || ""}</td>}
                    {onEdit && (
                      <td className="py-2">
                        <div className="flex gap-2">
                          <button className="px-2 py-1 rounded-lg border hover:bg-slate-100 dark:hover:bg-slate-800" onClick={() => { const amount = Number(prompt("Nuevo monto", String(t.amount)) || t.amount); if (!amount || amount <= 0) return; onEdit(t.id, { amount }); }}>Editar</button>
                          <button className="px-2 py-1 rounded-lg border hover:bg-slate-100 dark:hover:bg-slate-800" onClick={() => onDelete(t.id)}>Eliminar</button>
                        </div>
                      </td>
                    )}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function BudgetsTab({ budgets, upsertBudget, deleteBudget, categories, currency, month, expensesThisMonth }) {
        const allCats = categories.gasto; const current = budgets[month] || {}; const [cat, setCat] = useState(allCats[0] || ""); const [amount, setAmount] = useState(100);
        const spentMap = Object.fromEntries(expensesThisMonth.map((x) => [x.name, x.value]));
        const clearAll = () => { if (!confirm(`¬øEliminar TODOS los presupuestos del mes ${month}?`)) return; Object.keys(current).forEach((c) => deleteBudget(month, c)); };
        return (
          <section className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
              <h2 className="font-semibold mb-2">Definir/editar presupuesto mensual</h2>
              <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div>
                  <label className="text-xs text-slate-500">Categor√≠a</label>
                  <select value={cat} onChange={(e) => setCat(e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2">
                    {allCats.map((c) => (<option key={c} value={c}>{c}</option>))}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-slate-500">Monto</label>
                  <input type="number" step="0.01" value={amount} onChange={(e) => setAmount(e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" />
                </div>
                <div className="flex items-end gap-2">
                  <button onClick={() => upsertBudget(month, cat, amount)} className="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:opacity-90 w-full">Guardar</button>
                </div>
              </div>
              <div className="flex items-center justify-between mt-2">
                <p className="text-xs text-slate-500">Mes: {month}</p>
                {Object.keys(current).length > 0 && (<button onClick={clearAll} className="text-xs px-2 py-1 rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Eliminar todos</button>)}
              </div>
            </div>

            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
              <h2 className="font-semibold mb-2">Presupuestos definidos (este mes)</h2>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left text-slate-500 dark:text-slate-400">
                      <th className="py-2">Categor√≠a</th>
                      <th className="py-2">Presupuesto</th>
                      <th className="py-2">Gastado</th>
                      <th className="py-2">Disponible</th>
                      <th className="py-2">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.keys(current).length === 0 && (<tr><td colSpan={5} className="py-3 text-slate-500">A√∫n no hay presupuestos guardados para {month}</td></tr>)}
                    {Object.entries(current).map(([c, limit]) => {
                      const spent = spentMap[c] || 0;
                      return (
                        <tr key={c} className="border-t border-slate-100 dark:border-slate-800">
                          <td className="py-2 font-medium">{c}</td>
                          <td className="py-2">{fmtMoney(limit, currency)}</td>
                          <td className="py-2">{fmtMoney(spent, currency)}</td>
                          <td className={`py-2 ${limit - spent < 0 ? "text-red-600" : ""}`}>{fmtMoney(limit - spent, currency)}</td>
                          <td className="py-2">
                            <div className="flex gap-2">
                              <button className="px-2 py-1 rounded-lg border hover:bg-slate-100 dark:hover:bg-slate-800" onClick={() => { const newAmt = Number(prompt(`Nuevo monto para ${c}`, String(limit)) || limit); if (!isFinite(newAmt) || newAmt < 0) return; upsertBudget(month, c, newAmt); }}>Editar</button>
                              <button className="px-2 py-1 rounded-lg border hover:bg-slate-100 dark:hover:bg-slate-800" onClick={() => deleteBudget(month, c)}>Eliminar</button>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-2">
              <h2 className="font-semibold mb-2">Resumen por categor√≠as</h2>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left text-slate-500 dark:text-slate-400">
                      <th className="py-2">Categor√≠a</th>
                      <th className="py-2">Presupuesto</th>
                      <th className="py-2">Gastado</th>
                      <th className="py-2">Disponible</th>
                    </tr>
                  </thead>
                  <tbody>
                    {allCats.map((c) => {
                      const limit = current[c] || 0;
                      const spent = spentMap[c] || 0;
                      return (
                        <tr key={c} className="border-t border-slate-100 dark:border-slate-800">
                          <td className="py-2 font-medium">{c}</td>
                          <td className="py-2">{fmtMoney(limit, currency)}</td>
                          <td className="py-2">{fmtMoney(spent, currency)}</td>
                          <td className={`py-2 ${limit - spent < 0 ? "text-red-600" : ""}`}>{fmtMoney(limit - spent, currency)}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        );
      }

      function DebtsTab({ debts, addDebt, updateDebt, deleteDebt, currency }) {
        return (
          <section className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
              <h2 className="font-semibold mb-2">Agregar deuda</h2>
              <DebtForm onSubmit={addDebt} />
            </div>
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-2">
              <h2 className="font-semibold mb-2">Listado</h2>
              {!debts.length && <p className="text-sm text-slate-500">Sin deudas registradas.</p>}
              <div className="grid grid-cols-1 gap-3">
                {debts.map((d) => (<DebtCard key={d.id} d={d} currency={currency} onEdit={updateDebt} onDelete={deleteDebt} />))}
              </div>
            </div>
          </section>
        );
      }

      function DebtForm({ onSubmit }) {
        const [form, setForm] = useState({ name: "Tarjeta de cr√©dito", principal: 500, apr: 36, minPayment: 25, dueDay: 10, extraPayment: 0 });
        const handleSubmit = (e) => { e.preventDefault(); if (Number(form.principal) <= 0) return alert("Principal inv√°lido"); onSubmit({ ...form, principal: Number(form.principal), apr: Number(form.apr), minPayment: Number(form.minPayment), extraPayment: Number(form.extraPayment) }); setForm((f) => ({ ...f, name: "", principal: 0 })); };
        return (
          <form onSubmit={handleSubmit} className="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div><label className="text-xs text-slate-500">Nombre</label><input value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" placeholder="Banco, tarjeta, pr√©stamo" /></div>
            <div><label className="text-xs text-slate-500">Principal</label><input type="number" value={form.principal} onChange={(e) => setForm({ ...form, principal: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" /></div>
            <div><label className="text-xs text-slate-500">APR anual (%)</label><input type="number" value={form.apr} onChange={(e) => setForm({ ...form, apr: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" /></div>
            <div><label className="text-xs text-slate-500">Pago m√≠nimo mensual</label><input type="number" value={form.minPayment} onChange={(e) => setForm({ ...form, minPayment: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" /></div>
            <div><label className="text-xs text-slate-500">D√≠a de corte/Vencimiento</label><input type="number" value={form.dueDay} onChange={(e) => setForm({ ...form, dueDay: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" /></div>
            <div><label className="text-xs text-slate-500">Pago extra mensual</label><input type="number" value={form.extraPayment} onChange={(e) => setForm({ ...form, extraPayment: e.target.value })} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" /></div>
            <div className="sm:col-span-2 flex justify-end"><button className="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:opacity-90">Agregar</button></div>
          </form>
        );
      }

      function DebtCard({ d, currency, onEdit, onDelete }) {
        const monthlyRate = d.apr / 100 / 12; const minPay = Math.max(0, Number(d.minPayment) + Number(d.extraPayment || 0));
        let months = 0; let balance = Number(d.principal); let totalInterest = 0; const schedule = [];
        while (balance > 0 && months < 600) { const interest = balance * monthlyRate; const principalPaid = Math.max(0, minPay - interest); const newBalance = Math.max(0, balance - principalPaid); schedule.push({ month: months + 1, interest, principalPaid, newBalance }); totalInterest += interest; balance = newBalance; months++; if (minPay <= interest + 1e-6) { months = Infinity; break; } }
        const payoffMonths = Number.isFinite(months) ? months : null;
        return (
          <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
            <div className="flex items-start justify-between">
              <div>
                <h3 className="font-semibold">{d.name}</h3>
                <p className="text-xs text-slate-500">Principal: {fmtMoney(d.principal, currency)} ¬∑ APR: {d.apr}% ¬∑ M√≠n: {fmtMoney(d.minPayment, currency)} ¬∑ Extra: {fmtMoney(d.extraPayment || 0, currency)}</p>
              </div>
              <div className="flex gap-2">
                <button className="px-2 py-1 rounded-lg border hover:bg-slate-100 dark:hover:bg-slate-800" onClick={() => { const extra = Number(prompt("Nuevo pago extra mensual", String(d.extraPayment || 0)) || d.extraPayment || 0); onEdit(d.id, { extraPayment: extra }); }}>Editar</button>
                <button className="px-2 py-1 rounded-lg border hover:bg-slate-100 dark:hover:bg-slate-800" onClick={() => onDelete(d.id)}>Eliminar</button>
              </div>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3">
              <div className="rounded-xl border border-slate-200 dark:border-slate-800 p-3"><p className="text-xs text-slate-500">Pago mensual estimado</p><p className="text-lg font-semibold">{fmtMoney(minPay, currency)}</p></div>
              <div className="rounded-xl border border-slate-200 dark:border-slate-800 p-3"><p className="text-xs text-slate-500">Intereses totales</p><p className="text-lg font-semibold">{fmtMoney(totalInterest, currency)}</p></div>
              <div className="rounded-xl border border-slate-200 dark:border-slate-800 p-3"><p className="text-xs text-slate-500">Meses para salir</p><p className="text-lg font-semibold">{payoffMonths ? payoffMonths : "‚Äî"}</p></div>
            </div>
            <div className="h-48 mt-3">
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={schedule}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="month" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Line type="monotone" dataKey="newBalance" name="Saldo" />
                </LineChart>
              </ResponsiveContainer>
            </div>
          </div>
        );
      }

      function ReportsTab({ transactions, currency }) {
        const [from, setFrom] = useState(startOfMonth(new Date()).toISOString().slice(0, 10));
        const [to, setTo] = useState(endOfMonth(new Date()).toISOString().slice(0, 10));
        const filtered = useMemo(() => { const a = new Date(from); const b = new Date(to); return transactions.filter((t) => new Date(t.date) >= a && new Date(t.date) <= b); }, [transactions, from, to]);
        const byCat = useMemo(() => { const acc = {}; filtered.filter((t) => t.type === "gasto").forEach((t) => acc[t.category] = (acc[t.category] || 0) + Number(t.amount)); return Object.entries(acc).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value); }, [filtered]);
        const byDay = useMemo(() => { const map = new Map(); filtered.forEach((t) => { const key = t.date; const sign = t.type === "ingreso" ? 1 : -1; map.set(key, (map.get(key) || 0) + sign * Number(t.amount)); }); return Array.from(map.entries()).sort((a, b) => new Date(a[0]) - new Date(b[0])).map(([date, net]) => ({ date, net })); }, [filtered]);
        return (
          <section className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-3">
              <h2 className="font-semibold mb-3">Filtros</h2>
              <div className="grid grid-cols-2 sm:grid-cols-6 gap-3">
                <div><label className="text-xs text-slate-500">Desde</label><input type="date" value={from} onChange={(e) => setFrom(e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" /></div>
                <div><label className="text-xs text-slate-500">Hasta</label><input type="date" value={to} onChange={(e) => setTo(e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" /></div>
                <div className="col-span-2 sm:col-span-2 flex items-end"><a className="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm hover:bg-slate-100 dark:hover:bg-slate-800" href={makeCSV(filtered)} download={`reporte_${from}_a_${to}.csv`}>Exportar CSV</a></div>
              </div>
            </div>
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-2">
              <h2 className="font-semibold mb-2">Tendencia de neto (por d√≠a)</h2>
              <div className="h-64">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={byDay}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="date" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Line type="monotone" dataKey="net" name="Neto" />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
              <h2 className="font-semibold mb-2">Top categor√≠as (gasto)</h2>
              <ul className="space-y-2">
                {byCat.map((c, i) => (
                  <li key={c.name} className="flex items-center justify-between">
                    <span className="flex items-center gap-2"><span className="inline-block h-3 w-3 rounded-sm" style={{ background: CHART_COLORS[i % CHART_COLORS.length] }} />{c.name}</span>
                    <span className="font-medium">{fmtMoney(c.value, currency)}</span>
                  </li>
                ))}
                {!byCat.length && <li className="text-sm text-slate-500">Sin datos</li>}
              </ul>
            </div>
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-3">
              <h2 className="font-semibold mb-2">Detalle</h2>
              <TransactionList transactions={filtered} currency={currency} />
            </div>
          </section>
        );
      }

      function SettingsTab({ settings, setSettings }) {
        const [currency, setCurrency] = useState(settings.currency);
        const [incomeCats, setIncomeCats] = useState(settings.categories.ingreso.join("\n"));
        const [expenseCats, setExpenseCats] = useState(settings.categories.gasto.join("\n"));
        const apply = () => setSettings((s) => ({ ...s, currency, categories: { ingreso: incomeCats.split("\n").map((x) => x.trim()).filter(Boolean), gasto: expenseCats.split("\n").map((x) => x.trim()).filter(Boolean) } }));
        return (
          <section className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
              <h2 className="font-semibold mb-2">Preferencias</h2>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div><label className="text-xs text-slate-500">Moneda (ISO)</label><input value={currency} onChange={(e) => setCurrency(e.target.value.toUpperCase())} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2" placeholder="USD, CRC, NIO, HNL, GTQ..." /></div>
                <div className="flex items-end"><button onClick={apply} className="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:opacity-90 w-full">Guardar</button></div>
              </div>
              <p className="text-xs text-slate-500 mt-2">Consejo: si usas bancos locales y d√≥lares, mant√©n USD.</p>
            </div>
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900">
              <h2 className="font-semibold mb-2">Categor√≠as</h2>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div><label className="text-xs text-slate-500">Ingresos (una por l√≠nea)</label><textarea value={incomeCats} onChange={(e) => setIncomeCats(e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2 h-40" /></div>
                <div><label className="text-xs text-slate-500">Gastos (una por l√≠nea)</label><textarea value={expenseCats} onChange={(e) => setExpenseCats(e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-transparent px-3 py-2 h-40" /></div>
              </div>
            </div>
            <div className="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white dark:bg-slate-900 lg:col-span-2">
              <h2 className="font-semibold mb-2">Gu√≠a r√°pida de uso</h2>
              <ol className="list-decimal pl-5 space-y-1 text-sm text-slate-700 dark:text-slate-300">
                <li>Ve a <b>Transacciones</b> y registra tus ingresos y gastos (marca "Fijo" para rentas, servicios, etc.).</li>
                <li>Define tus <b>Presupuestos</b> por categor√≠a para el mes actual.</li>
                <li>En <b>Deudas</b> agrega tus pr√©stamos/tarjetas y prueba pagos extra para ver en cu√°ntos meses sales.</li>
                <li>Explora <b>Reportes</b> para ver tendencias y exportar CSV.</li>
                <li>Usa <b>Importar/Exportar</b> (arriba) para respaldos. Todo se guarda en este navegador.</li>
              </ol>
            </div>
          </section>
        );
      }

      // ---------------------- Helpers y Tests ------------------------------
      function makeCSV(rows) {
        if (!rows.length) return "data:text/csv;charset=utf-8,fecha,tipo,categoria,cuenta,monto,nota";
        const header = ["fecha","tipo","categoria","cuenta","monto","nota"]; const body = rows.map((r) => [r.date, r.type, quote(r.category), quote(r.account || ""), r.amount, quote(r.note || "")].join(",")).join("\n");
        return "data:text/csv;charset=utf-8," + encodeURIComponent(header.join(",") + "\n" + body);
      }
      function quote(s) { return '"' + String(s).replaceAll('"', '""') + '"'; }

      (function devTests(){ try {
        const mk = monthKey("2025-11-05"); const mkOk = mk && mk.length === 7 && mk[4] === '-' && !isNaN(+mk.slice(0,4)) && !isNaN(+mk.slice(5,7)); if (!mkOk) throw new Error("monthKey formato inv√°lido");
        const csv = makeCSV([{ date: "2025-11-05", type: "ingreso", category: "Salario", account: "Banco", amount: 1000, note: "" }]); if (typeof csv !== 'string' || csv.indexOf('data:text/csv') !== 0) throw new Error("CSV no generado");
        let state = { "2025-11": { Alimentos: 100 } }; const applyUpsert = (s, m, c, a) => ({ ...s, [m]: { ...(s[m] || {}), [c]: Number(a) } }); state = applyUpsert(state, "2025-11", "Alimentos", 200); if (state["2025-11"].Alimentos !== 200) throw new Error("upsertBudget");
        const monthly = 0.36 / 12; let bal = 1000; const pay = 100; const interest = bal * monthly; const principal = Math.max(0, pay - interest); const newBal = Math.max(0, bal - principal); if (!(newBal < bal)) throw new Error("debt sim");
        const cats = { ingreso: ["Salario", "Ventas"], gasto: ["Alimentaci√≥n", "Transporte"] }; let f = { type: "gasto", category: "Alimentaci√≥n" }; const switchType = (nextType) => { const list = nextType === "ingreso" ? cats.ingreso : cats.gasto; f = { ...f, type: nextType, category: (list && list[0]) || "" }; }; switchType("ingreso"); if (f.category !== "Salario") throw new Error("sync tipo‚Üícat");
        // console.log('Tests OK');
      } catch(e) { console.error('Dev test fallo:', e.message); } })();

      // Montaje
      ReactDOM.createRoot(document.getElementById('root')).render(<FinanceApp />);
    </script>
  </body>
</html>
